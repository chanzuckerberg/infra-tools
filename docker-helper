#!/bin/bash

set -eo pipefail

CMD="$1"

login()
{
    if [ -n "${AWS_PROFILE:-}" && [ -n "${AWS_DEFAULT_REGION:-}" ]; then
        echo "ECR login in progress"
        `aws ecr get-login --region us-west-2 --no-include-email`
    fi

    if [ -n "${DOCKER_USER:-}" ] && [ -n "${DOCKER_PASS:-}" ] ; then
        echo "Dockerhub login in progress"
        docker login -u $DOCKER_USER -p $DOCKER_PASS
    fi

    if [ -n "${GITHUB_USERNAME:-}" ] && [ -n "${GITHUB_TOKEN:-}" ] ; then
        echo "Github login in progress"
        docker login docker.pkg.github.com -u $GITHUB_USERNAME -p $GITHUB_TOKEN
    fi
}

case $CMD in
    build)
        REPO="$2"
        BUILD_PATH="$3"
        BRANCH=`echo $4 | sed 's/[\+\/]/-/g'`

        # Logic to determine the COMMIT tag
        if [ -n "$5" ]; then
            COMMIT="$5"
        elif [ -n "${CIRCLE_SHA1:-}" ]; then
            COMMIT="${CIRCLE_SHA1}"
        elif [ -n "${TRAVIS_COMMIT:-}" ]; then
            COMMIT="${TRAVIS_COMMIT}"
        else
            COMMIT=`git rev-parse --short HEAD`
        fi

        # Logic to determine the BUILD_NUMBER tag
        if [ -n "$6" ]; then
            BUILD_NUMBER="$6"
        elif [ -n "${CIRCLE_BUILD_NUM:-}" ]; then
            BUILD_NUMBER="${CIRCLE_BUILD_NUM}"
        elif [ -n "${TRAVIS_BUILD_NUMBER:-}" ]; then
            BUILD_NUMBER="${TRAVIS_BUILD_NUMBER}"
        else
            BUILD_NUMBER="unknown"
        fi

        CI_TAG="$REPO:ci"
        PROJ_NAME=$(basename $REPO)
        GITHUB_REPO="docker.pkg.github.com/$REPO/$PROJ_NAME"

        login

        docker pull $CI_TAG || true
        docker build --cache-from $CI_TAG -t $CI_TAG "$BUILD_PATH"

        echo "Tagging ${CI_TAG} with sha-${COMMIT}, branch-${BRANCH}, and build-${BUILD_NUMBER}"
        docker tag $CI_TAG $REPO:"sha-$COMMIT"
        docker tag $CI_TAG $REPO:"branch-$BRANCH"
        docker tag $CI_TAG $REPO:"build-$BUILD_NUMBER"

        # if github credentials set
        if [ -n "${GITHUB_USERNAME:-}" ] && [ -n "${GITHUB_TOKEN:-}" ]; then
            docker tag $CI_TAG $GITHUB_REPO:"sha-$COMMIT"
            docker tag $CI_TAG $GITHUB_REPO:"branch-$BRANCH"
        fi
    ;;
    push)
        REPO="$2"
        PROJ_NAME=$(basename $REPO)
        GITHUB_REPO="docker.pkg.github.com/$REPO/$PROJ_NAME"

        login

        # if dockerhub vars set, push dockerhub
        if [ -n "${DOCKER_USER:-}" ] && [ -n "${DOCKER_PASS:-}" ]; then
            echo "Pushing to Dockerhub"
            docker push $REPO
        fi

        # if github_user set, push to github
        if [ -n "${GITHUB_USERNAME:-}" ] && [ -n "${GITHUB_TOKEN:-}" ]; then
            echo "Pushing to Github Package Registry"
            docker push $GITHUB_REPO
            if [ $? -ne 0 ]; then
                echo "Push to $GITHUB_REPO failed"
            fi
        fi

        # if aws_profile set, push to AWS
        if [ -n "${AWS_PROFILE:-}" ]; then
            echo "Pushing to ECR"
            docker push $REPO
            if [ $? -ne 0 ]; then
                echo "Push to AWS ECR failed. $REPO"
            fi
        fi
    ;;
    *)
        echo "Unknown command $CMD"
        exit 1
esac
